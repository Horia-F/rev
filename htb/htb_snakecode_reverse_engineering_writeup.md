# HTB Snakecode – Reverse Engineering Writeup

**Challenge type:** Reverse Engineering (Python)

**Flag:** `HTB{SuP3r_S3CRt_Sn4k3c0d3}`

---

## 1. Initial Analysis

We are given an obfuscated Python script (`snake_obf.py`) which dynamically constructs functions from Base64 + zlib + marshal blobs. The code resembles a Snake game and heavily relies on runtime-generated functions.

Key observation from the source:

```python
ll = types.FunctionType(marshal.loads(BASE64_BLOB.decode('base64')), globals())
```

Each gameplay function (`f0`–`f8`, `a1`–`a9`, `m0`–`m2`) is produced dynamically using this loader.

This means:
- There is no readable Python source
- The real logic lives inside embedded Python **2.7 bytecode**

---

## 2. Extracting Embedded Bytecode

Each blob is:
1. Base64-decoded
2. zlib-decompressed
3. unmarshaled into a Python code object

To analyze them statically, we extracted every blob and rebuilt valid Python 2.7 `.pyc` files.

Key details:
- Bytecode version: **Python 2.7 (magic 62211)**
- Tools needed must support Python 2 bytecode

---

## 3. Why `dis.dis()` Does NOT Work

Python’s built-in `dis` module:
- Only works for bytecode generated by the **current interpreter**
- Cannot correctly disassemble Python 2.7 bytecode from Python 3

Attempting:
```python
import dis
dis.dis(a3)
```

Fails or produces misleading output.

---

## 4. Correct Tool: `xdis`

We used **xdis**, which is designed for cross-version bytecode analysis.

Command:
```bash
python3 -m xdis dumped_pyc/a4.pyc
```

This:
- Reads the `.pyc` file directly
- Detects Python 2.7 opcodes
- Displays accurate bytecode instructions

---

## 5. Finding the Flag (Static Analysis)

While inspecting one of the `a*` helper functions using `xdis`, we observed the following instructions:

```
LOAD_CONST "H"
LOAD_CONST "T"
LOAD_CONST "B"
LOAD_CONST "{"
LOAD_CONST "S"
LOAD_CONST "u"
LOAD_CONST "P"
LOAD_CONST "3"
LOAD_CONST "r"
LOAD_CONST "_"
LOAD_CONST "S"
LOAD_CONST "3"
LOAD_CONST "C"
LOAD_CONST "R"
LOAD_CONST "t"
LOAD_CONST "_"
LOAD_CONST "S"
LOAD_CONST "n"
LOAD_CONST "4"
LOAD_CONST "k"
LOAD_CONST "3"
LOAD_CONST "c"
LOAD_CONST "0"
LOAD_CONST "d"
LOAD_CONST "3"
LOAD_CONST "}"
```

Reading the constants in order reveals the flag directly.

---

## 6. Final Flag

```
HTB{SuP3r_S3CRt_Sn4k3c0d3}
```

---

## 7. Lessons Learned

- Obfuscated Python often hides logic in marshaled bytecode
- Python 2 bytecode **must not** be analyzed with Python 3 `dis`
- `xdis` + `uncompyle6` is the correct reversing toolchain
- Always inspect **constants** in bytecode – flags are often embedded verbatim

---

## 8. Tool Summary

| Tool | Purpose |
|----|----|
| `uncompyle6` | High-level source reconstruction |
| `xdis` | Accurate cross-version bytecode disassembly |
| `marshal` | Python bytecode container |

---

**Solved statically – no gameplay or runtime execution required.**

